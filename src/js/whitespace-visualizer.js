/*
 * =====================================================
 * Vinsert Editor - Á©∫ÁôΩÊñáÂ≠óÂèØË¶ñÂåñÊ©üËÉΩÔºà‰øÆÊ≠£ÁâàÔºâ
 * =====================================================
 */

import { 
    editor, 
    whitespaceVisualization, 
    setWhitespaceVisualization 
} from './globals.js';
import { closeAllMenus } from './menu-controller.js';
import { t } from './locales.js';

// Á©∫ÁôΩÊñáÂ≠óÂèØË¶ñÂåñ„ÅÆËâ≤Ë®≠ÂÆö
let whitespaceColors = {
    halfWidthSpace: { r: 128, g: 128, b: 128, a: 0.6 },  // „Éá„Éï„Ç©„É´„Éà: „Ç∞„É¨„Éº
    fullWidthSpace: { r: 100, g: 150, b: 255, a: 0.8 },  // „Éá„Éï„Ç©„É´„Éà: Èùí
    tab: { r: 255, g: 165, b: 0, a: 0.7 }                // „Éá„Éï„Ç©„É´„Éà: „Ç™„É¨„É≥„Ç∏
};

// ÂèØË¶ñÂåñ„Éû„Éº„Ç´„Éº„ÅÆ„Ç≥„É≥„ÉÜ„Éä
let markersContainer = null;
let updateScheduled = false;

/**
 * Á©∫ÁôΩÊñáÂ≠ó„ÅÆËâ≤Ë®≠ÂÆö„ÇíÊõ¥Êñ∞
 */
function updateWhitespaceColors(colors) {
    whitespaceColors = { ...whitespaceColors, ...colors };
    // „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Å´‰øùÂ≠ò
    try {
        localStorage.setItem('vinsert-whitespace-colors', JSON.stringify(whitespaceColors));
        console.log('üíæ Whitespace colors saved:', whitespaceColors);
    } catch (error) {
        console.warn('‚ö†Ô∏è Could not save whitespace colors:', error);
    }
}

/**
 * Á©∫ÁôΩÊñáÂ≠ó„ÅÆËâ≤Ë®≠ÂÆö„ÇíË™≠„ÅøËæº„Åø
 */
function loadWhitespaceColors() {
    try {
        const saved = localStorage.getItem('vinsert-whitespace-colors');
        if (saved) {
            const parsed = JSON.parse(saved);
            whitespaceColors = { ...whitespaceColors, ...parsed };
            console.log('üìÇ Whitespace colors loaded:', whitespaceColors);
        }
    } catch (error) {
        console.warn('‚ö†Ô∏è Could not load whitespace colors:', error);
    }
}

/**
 * RGBAËâ≤ÊñáÂ≠óÂàó„ÇíÁîüÊàê
 */
function getRGBA(colorObj) {
    return `rgba(${colorObj.r}, ${colorObj.g}, ${colorObj.b}, ${colorObj.a})`;
}

/**
 * ÁèæÂú®„ÅÆËâ≤Ë®≠ÂÆö„ÇíÂèñÂæó
 */
function getWhitespaceColors() {
    return {
        halfWidth: getRGBA(whitespaceColors.halfWidthSpace),
        fullWidth: getRGBA(whitespaceColors.fullWidthSpace),
        tab: getRGBA(whitespaceColors.tab)
    };
}

/**
 * Á©∫ÁôΩÊñáÂ≠óÂèØË¶ñÂåñ„ÅÆ„Ç™„É≥„Éª„Ç™„Éï„ÇíÂàá„ÇäÊõø„Åà„Çã
 */
export function toggleWhitespaceVisualization() {
    const newState = !whitespaceVisualization.enabled;
    setWhitespaceVisualization({ enabled: newState });
    
    // „É°„Éã„É•„Éº„Ç¢„Ç§„ÉÜ„É†„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØÁä∂ÊÖã„ÇíÊõ¥Êñ∞
    updateWhitespaceVisualizationMenuState(newState);
    
    if (!newState) {
        // ÂèØË¶ñÂåñ„ÇíÁÑ°Âäπ„Å´„Åó„ÅüÂ†¥Âêà„ÅØ„ÄÅÊó¢Â≠ò„ÅÆ„Éû„Éº„Ç´„Éº„ÇíÂâäÈô§
        removeAllMarkers();
    } else {
        // ÂèØË¶ñÂåñ„ÇíÊúâÂäπ„Å´„Åó„ÅüÂ†¥Âêà„ÅØ„ÄÅ„Éû„Éº„Ç´„Éº„ÇíË°®Á§∫
        updateWhitespaceMarkers();
    }
    
    closeAllMenus();
    
    console.log(`üëÅÔ∏è Whitespace visualization ${newState ? 'enabled' : 'disabled'}`);
}

/**
 * „É°„Éã„É•„Éº„Ç¢„Ç§„ÉÜ„É†„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØÁä∂ÊÖã„ÇíÊõ¥Êñ∞
 */
export function updateWhitespaceVisualizationMenuState(enabled) {
    const menuOption = document.getElementById('whitespace-visualization-menu-option');
    if (menuOption) {
        const checkmark = menuOption.querySelector('.menu-checkmark');
        if (checkmark) {
            checkmark.style.visibility = enabled ? 'visible' : 'hidden';
        }
    }
}

/**
 * Á©∫ÁôΩÊñáÂ≠óÂèØË¶ñÂåñË®≠ÂÆö„ÇíÂàùÊúüÂåñ
 */
export function initializeWhitespaceVisualization() {
    console.log('üëÅÔ∏è Initializing whitespace visualization...');
    
    // Ëâ≤Ë®≠ÂÆö„ÇíË™≠„ÅøËæº„Åø
    loadWhitespaceColors();
    
    // „Éû„Éº„Ç´„Éº„Ç≥„É≥„ÉÜ„Éä„Çí‰ΩúÊàê
    createMarkersContainer();
    
    // „É°„Éã„É•„Éº„ÅÆÂàùÊúüÁä∂ÊÖã„ÇíË®≠ÂÆö
    updateWhitespaceVisualizationMenuState(whitespaceVisualization.enabled);
    
    // ÂèØË¶ñÂåñ„ÅåÊúâÂäπ„Å™Â†¥Âêà„ÅØÂàùÊúü„Éû„Éº„Ç´„Éº„ÇíË®≠ÂÆö
    if (whitespaceVisualization.enabled) {
        setTimeout(() => {
            updateWhitespaceMarkers();
        }, 100);
    }
    
    console.log('‚úÖ Whitespace visualization initialized:', whitespaceVisualization);
    console.log('üé® Whitespace colors:', whitespaceColors);
}

/**
 * „Éû„Éº„Ç´„Éº„Ç≥„É≥„ÉÜ„Éä„Çí‰ΩúÊàê
 */
function createMarkersContainer() {
    if (markersContainer) {
        return;
    }
    
    const editorContainer = document.querySelector('.editor-container');
    if (!editorContainer) {
        console.error('‚ùå Editor container not found for whitespace markers');
        return;
    }
    
    markersContainer = document.createElement('div');
    markersContainer.className = 'whitespace-markers-container';
    markersContainer.style.cssText = `
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        pointer-events: none;
        z-index: 5;
        overflow: hidden;
        will-change: transform;
    `;
    
    editorContainer.appendChild(markersContainer);
    
    // „Ç®„Éá„Ç£„Çø„ÅÆ„Çπ„ÇØ„É≠„Éº„É´„Å®ÂêåÊúü
    if (editor) {
        const syncScroll = () => {
            if (markersContainer) {
                markersContainer.scrollTop = editor.scrollTop;
                markersContainer.scrollLeft = editor.scrollLeft;
            }
        };
        
        editor.addEventListener('scroll', syncScroll);
        syncScroll();
    }
    
    console.log('‚úÖ Whitespace markers container created with scroll sync');
}

/**
 * „Åô„Åπ„Å¶„ÅÆ„Éû„Éº„Ç´„Éº„ÇíÂâäÈô§
 */
function removeAllMarkers() {
    if (markersContainer) {
        markersContainer.innerHTML = '';
    }
}

/**
 * Á©∫ÁôΩÊñáÂ≠ó„Éû„Éº„Ç´„Éº„ÇíÊõ¥Êñ∞
 */
export function updateWhitespaceMarkers() {
    if (!whitespaceVisualization.enabled || !editor || !markersContainer) {
        return;
    }
    
    if (updateScheduled) {
        return;
    }
    
    updateScheduled = true;
    
    requestAnimationFrame(() => {
        try {
            performWhitespaceMarkersUpdate();
        } catch (error) {
            console.error('‚ùå Error updating whitespace markers:', error);
        } finally {
            updateScheduled = false;
        }
    });
}

/**
 * ÂÆüÈöõ„ÅÆ„Éû„Éº„Ç´„ÉºÊõ¥Êñ∞Âá¶ÁêÜ
 */
function performWhitespaceMarkersUpdate() {
    removeAllMarkers();
    
    const content = editor.value;
    if (!content) {
        return;
    }
    
    try {
        const computedStyle = window.getComputedStyle(editor);
        const fontSize = parseFloat(computedStyle.fontSize);
        const lineHeight = parseFloat(computedStyle.lineHeight);
        const paddingLeft = parseFloat(computedStyle.paddingLeft);
        const paddingTop = parseFloat(computedStyle.paddingTop);
        
        const lineNumbers = document.getElementById('line-numbers');
        const lineNumbersWidth = lineNumbers ? lineNumbers.offsetWidth : 0;
        
        const canvas = document.createElement('canvas');
        const context = canvas.getContext('2d');
        context.font = `${fontSize}px ${computedStyle.fontFamily}`;
        
        const spaceWidth = context.measureText(' ').width;
        const fullWidthSpaceWidth = context.measureText('„ÄÄ').width;
        const tabWidth = spaceWidth * 4;
        
        const scrollTop = editor.scrollTop;
        const scrollLeft = editor.scrollLeft;
        
        const editorHeight = editor.clientHeight;
        const visibleStartLine = Math.max(0, Math.floor(scrollTop / lineHeight) - 3);
        const visibleEndLine = Math.min(
            content.split('\n').length, 
            Math.ceil((scrollTop + editorHeight) / lineHeight) + 3
        );
        
        if (markersContainer) {
            markersContainer.style.transform = `translate(${-scrollLeft}px, ${-scrollTop}px)`;
        }
        
        const lines = content.split('\n');
        let currentY = paddingTop;
        
        for (let lineIndex = 0; lineIndex < lines.length; lineIndex++) {
            if (lineIndex < visibleStartLine || lineIndex > visibleEndLine) {
                currentY += lineHeight;
                continue;
            }
            
            const line = lines[lineIndex];
            let currentX = paddingLeft + lineNumbersWidth;
            
            for (let charIndex = 0; charIndex < line.length; charIndex++) {
                const char = line[charIndex];
                
                let markerType = null;
                let charWidth = 0;
                
                if (char === '\u3000' && whitespaceVisualization.showFullWidthSpace) {
                    markerType = 'fullwidth-space';
                    charWidth = fullWidthSpaceWidth;
                } else if (char === ' ' && whitespaceVisualization.showHalfWidthSpace) {
                    markerType = 'halfwidth-space';
                    charWidth = spaceWidth;
                } else if (char === '\t' && whitespaceVisualization.showTab) {
                    markerType = 'tab';
                    charWidth = tabWidth;
                } else {
                    charWidth = context.measureText(char).width;
                }
                
                if (markerType) {
                    createWhitespaceMarker(markerType, currentX, currentY, charWidth, lineHeight);
                }
                
                currentX += charWidth;
            }
            
            currentY += lineHeight;
        }
    } catch (error) {
        console.error('‚ùå Error in performWhitespaceMarkersUpdate:', error);
        removeAllMarkers();
    }
}

/**
 * Á©∫ÁôΩÊñáÂ≠ó„Éû„Éº„Ç´„Éº„Çí‰ΩúÊàêÔºàÊîπËâØÁâàÔºâ
 */
function createWhitespaceMarker(type, x, y, width, height) {
    try {
        if (!type || isNaN(x) || isNaN(y) || isNaN(width) || isNaN(height)) {
            console.warn('‚ö†Ô∏è Invalid marker parameters:', { type, x, y, width, height });
            return;
        }
        
        if (!markersContainer || !markersContainer.parentNode) {
            console.warn('‚ö†Ô∏è Markers container not available');
            return;
        }
        
        const colors = getWhitespaceColors();
        const marker = document.createElement('div');
        marker.className = `whitespace-marker whitespace-marker-${type}`;
        
        marker.style.cssText = `
            position: absolute;
            left: ${Math.round(x)}px;
            top: ${Math.round(y)}px;
            width: ${Math.round(width)}px;
            height: ${Math.round(height)}px;
            pointer-events: none;
            z-index: 6;
            display: flex;
            align-items: center;
            justify-content: center;
        `;
        
        switch (type) {
            case 'fullwidth-space':
                // ÂÖ®Ëßí„Çπ„Éö„Éº„Çπ: ÂØæËßíÁ∑öÂÖ•„Çä„ÅÆÂõõËßí
                marker.style.border = `1px solid ${colors.fullWidth}`;
                marker.style.backgroundColor = `${colors.fullWidth}20`;
                
                const diagonal1 = document.createElement('div');
                diagonal1.style.cssText = `
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 141%;
                    height: 1px;
                    background: ${colors.fullWidth};
                    transform: rotate(45deg);
                    transform-origin: 0 0;
                `;
                
                const diagonal2 = document.createElement('div');
                diagonal2.style.cssText = `
                    position: absolute;
                    top: 0;
                    right: 0;
                    width: 141%;
                    height: 1px;
                    background: ${colors.fullWidth};
                    transform: rotate(-45deg);
                    transform-origin: 100% 0;
                `;
                
                marker.appendChild(diagonal1);
                marker.appendChild(diagonal2);
                break;
                
            case 'halfwidth-space':
                // ÂçäËßí„Çπ„Éö„Éº„Çπ: ÂõõËßí„ÅßÂõ≤„Çì„Å†ÁÇπ
                const dotSize = Math.min(width * 0.5, height * 0.3, 4);
                const dot = document.createElement('div');
                dot.style.cssText = `
                    width: ${dotSize}px;
                    height: ${dotSize}px;
                    background: ${colors.halfWidth};
                    border-radius: 50%;
                `;
                
                marker.style.border = `1px solid ${colors.halfWidth}`;
                marker.style.backgroundColor = `${colors.halfWidth}10`;
                marker.appendChild(dot);
                break;
                
            case 'tab':
                // „Çø„ÉñÊñáÂ≠ó: Áü¢Âç∞„Éû„Éº„ÇØ
                marker.style.backgroundColor = `${colors.tab}20`;
                marker.style.borderBottom = `1px solid ${colors.tab}`;
                
                const tabArrow = document.createElement('div');
                tabArrow.style.cssText = `
                    color: ${colors.tab};
                    font-size: ${Math.max(10, Math.round(height * 0.6))}px;
                    line-height: 1;
                    font-family: monospace;
                    font-weight: bold;
                    margin-left: 2px;
                `;
                tabArrow.textContent = '‚Üí';
                marker.appendChild(tabArrow);
                break;
                
            default:
                console.warn('‚ö†Ô∏è Unknown marker type:', type);
                return;
        }
        
        markersContainer.appendChild(marker);
        
    } catch (error) {
        console.error('‚ùå Error creating whitespace marker:', error, { type, x, y, width, height });
    }
}

/**
 * „Çπ„ÇØ„É≠„Éº„É´ÊôÇ„ÅÆ„Éû„Éº„Ç´„ÉºÊõ¥Êñ∞
 */
export function updateWhitespaceMarkersOnScroll() {
    if (!whitespaceVisualization.enabled || !editor || !markersContainer) {
        return;
    }
    
    if (updateScheduled) {
        return;
    }
    
    updateScheduled = true;
    
    requestAnimationFrame(() => {
        requestAnimationFrame(() => {
            try {
                performWhitespaceMarkersUpdate();
            } catch (error) {
                console.error('‚ùå Error updating whitespace markers on scroll:', error);
                removeAllMarkers();
                setTimeout(() => {
                    try {
                        performWhitespaceMarkersUpdate();
                    } catch (retryError) {
                        console.error('‚ùå Retry also failed:', retryError);
                    }
                }, 100);
            } finally {
                updateScheduled = false;
            }
        });
    });
}

/**
 * RGBËâ≤ÈÅ∏ÊäûÊ©üËÉΩ‰ªò„ÅçÁ©∫ÁôΩÊñáÂ≠óÂèØË¶ñÂåñË®≠ÂÆö„ÉÄ„Ç§„Ç¢„É≠„Ç∞„ÇíË°®Á§∫
 */
export function showWhitespaceVisualizationDialog() {
    console.log('üëÅÔ∏è Opening enhanced whitespace visualization settings');
    closeAllMenus();
    
    const existingDialog = document.getElementById('whitespace-dialog-overlay');
    if (existingDialog) {
        document.body.removeChild(existingDialog);
    }
    
    createEnhancedWhitespaceVisualizationDialog();
}

/**
 * RGBËâ≤ÈÅ∏ÊäûÊ©üËÉΩ‰ªò„ÅçÁ©∫ÁôΩÊñáÂ≠óÂèØË¶ñÂåñË®≠ÂÆö„ÉÄ„Ç§„Ç¢„É≠„Ç∞„ÅÆ‰ΩúÊàê
 */
function createEnhancedWhitespaceVisualizationDialog() {
    const dialogOverlay = document.createElement('div');
    dialogOverlay.id = 'whitespace-dialog-overlay';
    dialogOverlay.className = 'search-dialog-overlay whitespace-dialog-overlay';
    
    const dialog = document.createElement('div');
    dialog.className = 'search-dialog whitespace-dialog enhanced-whitespace-dialog';
    
    dialog.innerHTML = `
        <div class="search-dialog-header">Á©∫ÁôΩÊñáÂ≠ó„ÅÆË®≠ÂÆö</div>
        <div class="search-dialog-content">
            <div class="whitespace-settings-section">
                <div class="search-checkbox-group">
                    <label class="search-checkbox-label">
                        <input type="checkbox" id="ws-enable-checkbox" ${whitespaceVisualization.enabled ? 'checked' : ''}>
                        Á©∫ÁôΩÊñáÂ≠ó„ÅÆÂèØË¶ñÂåñ„ÇíÊúâÂäπ„Å´„Åô„Çã
                    </label>
                </div>
                
                <div class="whitespace-type-settings">
                    <h4 style="margin: 16px 0 12px 0; color: #cccccc;">Ë°®Á§∫„Åô„ÇãÁ©∫ÁôΩÊñáÂ≠ó„ÅÆÁ®ÆÈ°û</h4>
                    
                    <label class="search-checkbox-label">
                        <input type="checkbox" id="ws-halfwidth-checkbox" ${whitespaceVisualization.showHalfWidthSpace ? 'checked' : ''}>
                        ÂçäËßí„Çπ„Éö„Éº„ÇπÔºà Ôºâ- ÂõõËßí„ÅßÂõ≤„Çì„Å†ÁÇπ
                    </label>
                    
                    <label class="search-checkbox-label">
                        <input type="checkbox" id="ws-fullwidth-checkbox" ${whitespaceVisualization.showFullWidthSpace ? 'checked' : ''}>
                        ÂÖ®Ëßí„Çπ„Éö„Éº„ÇπÔºà„ÄÄÔºâ- ÂØæËßíÁ∑öÂÖ•„Çä„ÅÆÂõõËßí
                    </label>
                    
                    <label class="search-checkbox-label">
                        <input type="checkbox" id="ws-tab-checkbox" ${whitespaceVisualization.showTab ? 'checked' : ''}>
                        „Çø„ÉñÊñáÂ≠óÔºà‚ÜíÔºâ- Áü¢Âç∞„Éû„Éº„ÇØ
                    </label>
                </div>
                
                <div class="whitespace-color-settings">
                    <h4 style="margin: 16px 0 12px 0; color: #cccccc;">Ëâ≤Ë®≠ÂÆöÔºàRGBÔºâ</h4>
                    
                    <div class="color-setting-group">
                        <label>ÂçäËßí„Çπ„Éö„Éº„Çπ„ÅÆËâ≤:</label>
                        <div class="color-inputs">
                            <span>R:</span><input type="number" id="halfwidth-r" min="0" max="255" value="${whitespaceColors.halfWidthSpace.r}">
                            <span>G:</span><input type="number" id="halfwidth-g" min="0" max="255" value="${whitespaceColors.halfWidthSpace.g}">
                            <span>B:</span><input type="number" id="halfwidth-b" min="0" max="255" value="${whitespaceColors.halfWidthSpace.b}">
                            <span>ÈÄèÊòéÂ∫¶:</span><input type="range" id="halfwidth-a" min="0" max="1" step="0.1" value="${whitespaceColors.halfWidthSpace.a}">
                            <div class="color-preview" id="halfwidth-preview"></div>
                        </div>
                    </div>
                    
                    <div class="color-setting-group">
                        <label>ÂÖ®Ëßí„Çπ„Éö„Éº„Çπ„ÅÆËâ≤:</label>
                        <div class="color-inputs">
                            <span>R:</span><input type="number" id="fullwidth-r" min="0" max="255" value="${whitespaceColors.fullWidthSpace.r}">
                            <span>G:</span><input type="number" id="fullwidth-g" min="0" max="255" value="${whitespaceColors.fullWidthSpace.g}">
                            <span>B:</span><input type="number" id="fullwidth-b" min="0" max="255" value="${whitespaceColors.fullWidthSpace.b}">
                            <span>ÈÄèÊòéÂ∫¶:</span><input type="range" id="fullwidth-a" min="0" max="1" step="0.1" value="${whitespaceColors.fullWidthSpace.a}">
                            <div class="color-preview" id="fullwidth-preview"></div>
                        </div>
                    </div>
                    
                    <div class="color-setting-group">
                        <label>„Çø„Éñ„ÅÆËâ≤:</label>
                        <div class="color-inputs">
                            <span>R:</span><input type="number" id="tab-r" min="0" max="255" value="${whitespaceColors.tab.r}">
                            <span>G:</span><input type="number" id="tab-g" min="0" max="255" value="${whitespaceColors.tab.g}">
                            <span>B:</span><input type="number" id="tab-b" min="0" max="255" value="${whitespaceColors.tab.b}">
                            <span>ÈÄèÊòéÂ∫¶:</span><input type="range" id="tab-a" min="0" max="1" step="0.1" value="${whitespaceColors.tab.a}">
                            <div class="color-preview" id="tab-preview"></div>
                        </div>
                    </div>
                </div>
                
                <div class="whitespace-preview-section">
                    <label style="display: block; margin: 16px 0 8px 0; color: #cccccc;">„Éó„É¨„Éì„É•„Éº</label>
                    <div class="whitespace-preview">
function example() {
    console.log('Hello');„ÄÄ// ÂÖ®Ëßí„Çπ„Éö„Éº„Çπ
	return 42;    // „Çø„Éñ + ÂçäËßí„Çπ„Éö„Éº„Çπ
}
                    </div>
                </div>
            </div>
            
            <div class="search-button-group">
                <button id="whitespace-apply-btn" class="search-button search-button-primary">ÈÅ©Áî®</button>
                <button id="whitespace-reset-btn" class="search-button">„É™„Çª„ÉÉ„Éà</button>
                <button id="whitespace-cancel-btn" class="search-button search-button-cancel">„Ç≠„É£„É≥„Çª„É´</button>
            </div>
        </div>
    `;
    
    dialogOverlay.appendChild(dialog);
    document.body.appendChild(dialogOverlay);
    
    setupEnhancedWhitespaceVisualizationDialogEvents(dialogOverlay);
    updateColorPreviews();
    
    setTimeout(() => {
        const enableCheckbox = document.getElementById('ws-enable-checkbox');
        if (enableCheckbox) {
            enableCheckbox.focus();
        }
    }, 100);
}

/**
 * Ëâ≤„Éó„É¨„Éì„É•„Éº„ÇíÊõ¥Êñ∞
 */
function updateColorPreviews() {
    const types = ['halfwidth', 'fullwidth', 'tab'];
    
    types.forEach(type => {
        const r = document.getElementById(`${type}-r`).value;
        const g = document.getElementById(`${type}-g`).value;
        const b = document.getElementById(`${type}-b`).value;
        const a = document.getElementById(`${type}-a`).value;
        
        const preview = document.getElementById(`${type}-preview`);
        if (preview) {
            preview.style.backgroundColor = `rgba(${r}, ${g}, ${b}, ${a})`;
        }
    });
}

/**
 * Êã°ÂºµÁ©∫ÁôΩÊñáÂ≠óÂèØË¶ñÂåñË®≠ÂÆö„ÉÄ„Ç§„Ç¢„É≠„Ç∞„ÅÆ„Ç§„Éô„É≥„ÉàË®≠ÂÆö
 */
function setupEnhancedWhitespaceVisualizationDialogEvents(dialogOverlay) {
    const enableCheckbox = document.getElementById('ws-enable-checkbox');
    const fullwidthCheckbox = document.getElementById('ws-fullwidth-checkbox');
    const halfwidthCheckbox = document.getElementById('ws-halfwidth-checkbox');
    const tabCheckbox = document.getElementById('ws-tab-checkbox');
    const applyBtn = document.getElementById('whitespace-apply-btn');
    const resetBtn = document.getElementById('whitespace-reset-btn');
    const cancelBtn = document.getElementById('whitespace-cancel-btn');
    
    const originalSettings = { ...whitespaceVisualization };
    const originalColors = JSON.parse(JSON.stringify(whitespaceColors));
    
    enableCheckbox.addEventListener('change', () => {
        const enabled = enableCheckbox.checked;
        fullwidthCheckbox.disabled = !enabled;
        halfwidthCheckbox.disabled = !enabled;
        tabCheckbox.disabled = !enabled;
        
        const colorInputs = document.querySelectorAll('.color-inputs input');
        colorInputs.forEach(input => input.disabled = !enabled);
        
        const typeSettings = document.querySelector('.whitespace-type-settings');
        const colorSettings = document.querySelector('.whitespace-color-settings');
        if (typeSettings) typeSettings.style.opacity = enabled ? '1' : '0.5';
        if (colorSettings) colorSettings.style.opacity = enabled ? '1' : '0.5';
    });
    
    const colorInputs = document.querySelectorAll('.color-inputs input');
    colorInputs.forEach(input => {
        input.addEventListener('input', updateColorPreviews);
    });
    
    resetBtn.addEventListener('click', () => {
        if (confirm('Ëâ≤Ë®≠ÂÆö„Çí„Éá„Éï„Ç©„É´„Éà„Å´Êàª„Åó„Åæ„Åô„ÅãÔºü')) {
            document.getElementById('halfwidth-r').value = 128;
            document.getElementById('halfwidth-g').value = 128;
            document.getElementById('halfwidth-b').value = 128;
            document.getElementById('halfwidth-a').value = 0.6;
            
            document.getElementById('fullwidth-r').value = 100;
            document.getElementById('fullwidth-g').value = 150;
            document.getElementById('fullwidth-b').value = 255;
            document.getElementById('fullwidth-a').value = 0.8;
            
            document.getElementById('tab-r').value = 255;
            document.getElementById('tab-g').value = 165;
            document.getElementById('tab-b').value = 0;
            document.getElementById('tab-a').value = 0.7;
            
            updateColorPreviews();
        }
    });
    
    enableCheckbox.dispatchEvent(new Event('change'));
    
    applyBtn.addEventListener('click', () => {
        const newSettings = {
            enabled: enableCheckbox.checked,
            showFullWidthSpace: fullwidthCheckbox.checked,
            showHalfWidthSpace: halfwidthCheckbox.checked,
            showTab: tabCheckbox.checked
        };
        
        const newColors = {
            halfWidthSpace: {
                r: parseInt(document.getElementById('halfwidth-r').value),
                g: parseInt(document.getElementById('halfwidth-g').value),
                b: parseInt(document.getElementById('halfwidth-b').value),
                a: parseFloat(document.getElementById('halfwidth-a').value)
            },
            fullWidthSpace: {
                r: parseInt(document.getElementById('fullwidth-r').value),
                g: parseInt(document.getElementById('fullwidth-g').value),
                b: parseInt(document.getElementById('fullwidth-b').value),
                a: parseFloat(document.getElementById('fullwidth-a').value)
            },
            tab: {
                r: parseInt(document.getElementById('tab-r').value),
                g: parseInt(document.getElementById('tab-g').value),
                b: parseInt(document.getElementById('tab-b').value),
                a: parseFloat(document.getElementById('tab-a').value)
            }
        };
        
        setWhitespaceVisualization(newSettings);
        updateWhitespaceColors(newColors);
        updateWhitespaceVisualizationMenuState(newSettings.enabled);
        
        if (newSettings.enabled) {
            updateWhitespaceMarkers();
        } else {
            removeAllMarkers();
        }
        
        closeWhitespaceVisualizationDialog(dialogOverlay);
        console.log('‚úÖ Enhanced whitespace visualization settings applied:', newSettings, newColors);
    });
    
    cancelBtn.addEventListener('click', () => {
        setWhitespaceVisualization(originalSettings);
        updateWhitespaceColors(originalColors);
        closeWhitespaceVisualizationDialog(dialogOverlay);
        console.log('‚ùå Enhanced whitespace visualization settings cancelled');
    });
    
    function handleKeyDown(e) {
        if (e.key === 'Escape') {
            setWhitespaceVisualization(originalSettings);
            updateWhitespaceColors(originalColors);
            closeWhitespaceVisualizationDialog(dialogOverlay);
        }
    }
    
    document.addEventListener('keydown', handleKeyDown);
    
    dialogOverlay.addEventListener('click', (e) => {
        if (e.target === dialogOverlay) {
            setWhitespaceVisualization(originalSettings);
            updateWhitespaceColors(originalColors);
            closeWhitespaceVisualizationDialog(dialogOverlay);
        }
    });
    
    dialogOverlay.addEventListener('remove', () => {
        document.removeEventListener('keydown', handleKeyDown);
    });
}

/**
 * Á©∫ÁôΩÊñáÂ≠óÂèØË¶ñÂåñË®≠ÂÆö„ÉÄ„Ç§„Ç¢„É≠„Ç∞„ÇíÈñâ„Åò„Çã
 */
function closeWhitespaceVisualizationDialog(dialogOverlay) {
    try {
        document.body.removeChild(dialogOverlay);
        
        setTimeout(() => {
            if (editor && editor.focus) {
                editor.focus();
            }
        }, 100);
    } catch (error) {
        console.warn('‚ö†Ô∏è Error closing whitespace visualization dialog:', error);
    }
}

/**
 * RGBËâ≤ÈÅ∏ÊäûÊ©üËÉΩ‰ªò„ÅçÁ©∫ÁôΩÊñáÂ≠óÂèØË¶ñÂåñË®≠ÂÆö„ÉÄ„Ç§„Ç¢„É≠„Ç∞„ÅÆ‰ΩúÊàê
 */
function createEnhancedWhitespaceVisualizationDialog() {
    const dialogOverlay = document.createElement('div');
    dialogOverlay.id = 'whitespace-dialog-overlay';
    dialogOverlay.className = 'search-dialog-overlay whitespace-dialog-overlay';
    
    const dialog = document.createElement('div');
    dialog.className = 'search-dialog whitespace-dialog enhanced-whitespace-dialog';
    
    dialog.innerHTML = `
        <div class="search-dialog-header">${t('viewMenu.whitespaceSettings')}</div>
        <div class="search-dialog-content">
            <div class="whitespace-settings-section">
                <div class="search-checkbox-group">
                    <label class="search-checkbox-label">
                        <input type="checkbox" id="ws-enable-checkbox" ${whitespaceVisualization.enabled ? 'checked' : ''}>
                        ${t('whitespace.enable')}
                    </label>
                </div>
                
                <div class="whitespace-type-settings">
                    <h4 style="margin: 16px 0 12px 0; color: #cccccc;">${t('whitespace.typeSettings')}</h4>
                    
                    <label class="search-checkbox-label">
                        <input type="checkbox" id="ws-halfwidth-checkbox" ${whitespaceVisualization.showHalfWidthSpace ? 'checked' : ''}>
                        ÂçäËßí„Çπ„Éö„Éº„ÇπÔºà Ôºâ- ÂõõËßí„ÅßÂõ≤„Çì„Å†ÁÇπ
                    </label>
                    
                    <label class="search-checkbox-label">
                        <input type="checkbox" id="ws-fullwidth-checkbox" ${whitespaceVisualization.showFullWidthSpace ? 'checked' : ''}>
                        ÂÖ®Ëßí„Çπ„Éö„Éº„ÇπÔºà„ÄÄÔºâ- ÂØæËßíÁ∑öÂÖ•„Çä„ÅÆÂõõËßí
                    </label>
                    
                    <label class="search-checkbox-label">
                        <input type="checkbox" id="ws-tab-checkbox" ${whitespaceVisualization.showTab ? 'checked' : ''}>
                        „Çø„ÉñÊñáÂ≠óÔºà‚ÜíÔºâ- Áü¢Âç∞„Éû„Éº„ÇØ
                    </label>
                </div>
                
                <div class="whitespace-color-settings">
                    <h4 style="margin: 16px 0 12px 0; color: #cccccc;">Ëâ≤Ë®≠ÂÆöÔºàRGBÔºâ</h4>
                    
                    <div class="color-setting-group">
                        <label>ÂçäËßí„Çπ„Éö„Éº„Çπ„ÅÆËâ≤:</label>
                        <div class="color-inputs">
                            <span>R:</span><input type="number" id="halfwidth-r" min="0" max="255" value="${whitespaceColors.halfWidthSpace.r}">
                            <span>G:</span><input type="number" id="halfwidth-g" min="0" max="255" value="${whitespaceColors.halfWidthSpace.g}">
                            <span>B:</span><input type="number" id="halfwidth-b" min="0" max="255" value="${whitespaceColors.halfWidthSpace.b}">
                            <span>ÈÄèÊòéÂ∫¶:</span><input type="range" id="halfwidth-a" min="0" max="1" step="0.1" value="${whitespaceColors.halfWidthSpace.a}">
                            <div class="color-preview" id="halfwidth-preview"></div>
                        </div>
                    </div>
                    
                    <div class="color-setting-group">
                        <label>ÂÖ®Ëßí„Çπ„Éö„Éº„Çπ„ÅÆËâ≤:</label>
                        <div class="color-inputs">
                            <span>R:</span><input type="number" id="fullwidth-r" min="0" max="255" value="${whitespaceColors.fullWidthSpace.r}">
                            <span>G:</span><input type="number" id="fullwidth-g" min="0" max="255" value="${whitespaceColors.fullWidthSpace.g}">
                            <span>B:</span><input type="number" id="fullwidth-b" min="0" max="255" value="${whitespaceColors.fullWidthSpace.b}">
                            <span>ÈÄèÊòéÂ∫¶:</span><input type="range" id="fullwidth-a" min="0" max="1" step="0.1" value="${whitespaceColors.fullWidthSpace.a}">
                            <div class="color-preview" id="fullwidth-preview"></div>
                        </div>
                    </div>
                    
                    <div class="color-setting-group">
                        <label>„Çø„Éñ„ÅÆËâ≤:</label>
                        <div class="color-inputs">
                            <span>R:</span><input type="number" id="tab-r" min="0" max="255" value="${whitespaceColors.tab.r}">
                            <span>G:</span><input type="number" id="tab-g" min="0" max="255" value="${whitespaceColors.tab.g}">
                            <span>B:</span><input type="number" id="tab-b" min="0" max="255" value="${whitespaceColors.tab.b}">
                            <span>ÈÄèÊòéÂ∫¶:</span><input type="range" id="tab-a" min="0" max="1" step="0.1" value="${whitespaceColors.tab.a}">
                            <div class="color-preview" id="tab-preview"></div>
                        </div>
                    </div>
                </div>
                
                <div class="whitespace-preview-section">
                    <label style="display: block; margin: 16px 0 8px 0; color: #cccccc;">${t('fonts.preview')}</label>
                    <div class="whitespace-preview">
function example() {
    console.log('Hello');„ÄÄ// ÂÖ®Ëßí„Çπ„Éö„Éº„Çπ
	return 42;    // „Çø„Éñ + ÂçäËßí„Çπ„Éö„Éº„Çπ
}
                    </div>
                </div>
            </div>
            
            <div class="search-button-group">
                <button id="whitespace-apply-btn" class="search-button search-button-primary">${t('fonts.buttons.apply')}</button>
                <button id="whitespace-reset-btn" class="search-button">${t('fonts.buttons.reset')}</button>
                <button id="whitespace-cancel-btn" class="search-button search-button-cancel">${t('fonts.buttons.cancel')}</button>
            </div>
        </div>
    `;
    
    dialogOverlay.appendChild(dialog);
    document.body.appendChild(dialogOverlay);
    
    setupEnhancedWhitespaceVisualizationDialogEvents(dialogOverlay);
    
    // ÂàùÊúüËâ≤„Éó„É¨„Éì„É•„Éº„ÇíÊõ¥Êñ∞
    updateColorPreviews();
    
    // ÊúâÂäπ/ÁÑ°Âäπ„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„Å´„Éï„Ç©„Éº„Ç´„Çπ
    setTimeout(() => {
        const enableCheckbox = document.getElementById('ws-enable-checkbox');
        if (enableCheckbox) {
            enableCheckbox.focus();
        }
    }, 100);
}

/**
 * Ëâ≤„Éó„É¨„Éì„É•„Éº„ÇíÊõ¥Êñ∞
 */
function updateColorPreviews() {
    const types = ['halfwidth', 'fullwidth', 'tab'];
    
    types.forEach(type => {
        const r = document.getElementById(`${type}-r`).value;
        const g = document.getElementById(`${type}-g`).value;
        const b = document.getElementById(`${type}-b`).value;
        const a = document.getElementById(`${type}-a`).value;
        
        const preview = document.getElementById(`${type}-preview`);
        if (preview) {
            preview.style.backgroundColor = `rgba(${r}, ${g}, ${b}, ${a})`;
        }
    });
}

/**
 * Êã°ÂºµÁ©∫ÁôΩÊñáÂ≠óÂèØË¶ñÂåñË®≠ÂÆö„ÉÄ„Ç§„Ç¢„É≠„Ç∞„ÅÆ„Ç§„Éô„É≥„ÉàË®≠ÂÆö
 */
function setupEnhancedWhitespaceVisualizationDialogEvents(dialogOverlay) {
    const enableCheckbox = document.getElementById('ws-enable-checkbox');
    const fullwidthCheckbox = document.getElementById('ws-fullwidth-checkbox');
    const halfwidthCheckbox = document.getElementById('ws-halfwidth-checkbox');
    const tabCheckbox = document.getElementById('ws-tab-checkbox');
    const applyBtn = document.getElementById('whitespace-apply-btn');
    const resetBtn = document.getElementById('whitespace-reset-btn');
    const cancelBtn = document.getElementById('whitespace-cancel-btn');
    
    // ‰∏ÄÊôÇÁöÑ„Å™Ë®≠ÂÆö„Çí‰øùÂ≠òÔºà„Ç≠„É£„É≥„Çª„É´ÊôÇ„ÅÆÂæ©ÂÖÉÁî®Ôºâ
    const originalSettings = { ...whitespaceVisualization };
    const originalColors = JSON.parse(JSON.stringify(whitespaceColors));
    
    // ÊúâÂäπ/ÁÑ°Âäπ„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÅÆÂ§âÊõ¥
    enableCheckbox.addEventListener('change', () => {
        const enabled = enableCheckbox.checked;
        fullwidthCheckbox.disabled = !enabled;
        halfwidthCheckbox.disabled = !enabled;
        tabCheckbox.disabled = !enabled;
        
        // Ëâ≤Ë®≠ÂÆö„ÅÆÊúâÂäπ/ÁÑ°Âäπ
        const colorInputs = document.querySelectorAll('.color-inputs input');
        colorInputs.forEach(input => input.disabled = !enabled);
        
        // Ë¶ã„ÅüÁõÆ„ÅÆÊõ¥Êñ∞
        const typeSettings = document.querySelector('.whitespace-type-settings');
        const colorSettings = document.querySelector('.whitespace-color-settings');
        if (typeSettings) typeSettings.style.opacity = enabled ? '1' : '0.5';
        if (colorSettings) colorSettings.style.opacity = enabled ? '1' : '0.5';
    });
    
    // Ëâ≤ÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„ÅÆÂ§âÊõ¥„Ç§„Éô„É≥„Éà
    const colorInputs = document.querySelectorAll('.color-inputs input');
    colorInputs.forEach(input => {
        input.addEventListener('input', updateColorPreviews);
    });
    
    // „É™„Çª„ÉÉ„Éà„Éú„Çø„É≥
    resetBtn.addEventListener('click', () => {
        if (confirm('Ëâ≤Ë®≠ÂÆö„Çí„Éá„Éï„Ç©„É´„Éà„Å´Êàª„Åó„Åæ„Åô„ÅãÔºü')) {
            // „Éá„Éï„Ç©„É´„ÉàËâ≤„Çí„Éï„Ç£„Éº„É´„Éâ„Å´Ë®≠ÂÆö
            document.getElementById('halfwidth-r').value = 128;
            document.getElementById('halfwidth-g').value = 128;
            document.getElementById('halfwidth-b').value = 128;
            document.getElementById('halfwidth-a').value = 0.6;
            
            document.getElementById('fullwidth-r').value = 100;
            document.getElementById('fullwidth-g').value = 150;
            document.getElementById('fullwidth-b').value = 255;
            document.getElementById('fullwidth-a').value = 0.8;
            
            document.getElementById('tab-r').value = 255;
            document.getElementById('tab-g').value = 165;
            document.getElementById('tab-b').value = 0;
            document.getElementById('tab-a').value = 0.7;
            
            updateColorPreviews();
        }
    });
    
    // ÂàùÊúüÁä∂ÊÖã„ÅÆË®≠ÂÆö
    enableCheckbox.dispatchEvent(new Event('change'));
    
    // ÈÅ©Áî®„Éú„Çø„É≥
    applyBtn.addEventListener('click', () => {
        const newSettings = {
            enabled: enableCheckbox.checked,
            showFullWidthSpace: fullwidthCheckbox.checked,
            showHalfWidthSpace: halfwidthCheckbox.checked,
            showTab: tabCheckbox.checked
        };
        
        const newColors = {
            halfWidthSpace: {
                r: parseInt(document.getElementById('halfwidth-r').value),
                g: parseInt(document.getElementById('halfwidth-g').value),
                b: parseInt(document.getElementById('halfwidth-b').value),
                a: parseFloat(document.getElementById('halfwidth-a').value)
            },
            fullWidthSpace: {
                r: parseInt(document.getElementById('fullwidth-r').value),
                g: parseInt(document.getElementById('fullwidth-g').value),
                b: parseInt(document.getElementById('fullwidth-b').value),
                a: parseFloat(document.getElementById('fullwidth-a').value)
            },
            tab: {
                r: parseInt(document.getElementById('tab-r').value),
                g: parseInt(document.getElementById('tab-g').value),
                b: parseInt(document.getElementById('tab-b').value),
                a: parseFloat(document.getElementById('tab-a').value)
            }
        };
        
        setWhitespaceVisualization(newSettings);
        updateWhitespaceColors(newColors);
        updateWhitespaceVisualizationMenuState(newSettings.enabled);
        
        if (newSettings.enabled) {
            updateWhitespaceMarkers();
        } else {
            removeAllMarkers();
        }
        
        closeWhitespaceVisualizationDialog(dialogOverlay);
        console.log('‚úÖ Enhanced whitespace visualization settings applied:', newSettings, newColors);
    });
    
    // „Ç≠„É£„É≥„Çª„É´„Éú„Çø„É≥
    cancelBtn.addEventListener('click', () => {
        // ÂÖÉ„ÅÆË®≠ÂÆö„Å´Êàª„Åô
        setWhitespaceVisualization(originalSettings);
        updateWhitespaceColors(originalColors);
        closeWhitespaceVisualizationDialog(dialogOverlay);
        console.log('‚ùå Enhanced whitespace visualization settings cancelled');
    });
    
    // ESC„Ç≠„Éº„Åß„Ç≠„É£„É≥„Çª„É´
    function handleKeyDown(e) {
        if (e.key === 'Escape') {
            setWhitespaceVisualization(originalSettings);
            updateWhitespaceColors(originalColors);
            closeWhitespaceVisualizationDialog(dialogOverlay);
        }
    }
    
    document.addEventListener('keydown', handleKeyDown);
    
    // „Ç™„Éº„Éê„Éº„É¨„Ç§„ÇØ„É™„ÉÉ„ÇØ„Åß„Ç≠„É£„É≥„Çª„É´
    dialogOverlay.addEventListener('click', (e) => {
        if (e.target === dialogOverlay) {
            setWhitespaceVisualization(originalSettings);
            updateWhitespaceColors(originalColors);
            closeWhitespaceVisualizationDialog(dialogOverlay);
        }
    });
    
    dialogOverlay.addEventListener('remove', () => {
        document.removeEventListener('keydown', handleKeyDown);
    });
}