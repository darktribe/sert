#!/bin/bash
# scripts/prepare-python.sh
# Python.frameworkã‚’æº–å‚™ã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆä¿®æ­£ç‰ˆï¼‰

set -e

PYTHON_VERSION="3.11"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"
PYTHON_RUNTIME_DIR="$PROJECT_ROOT/src-tauri/python-runtime"

echo "ğŸ Preparing Python runtime for Vinsert..."
echo "ğŸ“ Project root: $PROJECT_ROOT"
echo "ğŸ“ Python runtime dir: $PYTHON_RUNTIME_DIR"

# æ—¢å­˜ã®python-runtimeãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ã‚¯ãƒªã‚¢
if [ -d "$PYTHON_RUNTIME_DIR" ]; then
    echo "ğŸ—‘ï¸ Cleaning existing Python runtime..."
    rm -rf "$PYTHON_RUNTIME_DIR"
fi

# Python runtimeãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
mkdir -p "$PYTHON_RUNTIME_DIR"

# Python.frameworkã®å ´æ‰€ã‚’æ¢ã™
PYTHON_FRAMEWORK_PATHS=(
    "/Library/Frameworks/Python.framework/Versions/$PYTHON_VERSION"
    "/usr/local/Frameworks/Python.framework/Versions/$PYTHON_VERSION"
    "$(brew --prefix 2>/dev/null)/Frameworks/Python.framework/Versions/$PYTHON_VERSION"
    "$HOME/.pyenv/versions/$PYTHON_VERSION.*/Python.framework/Versions/$PYTHON_VERSION"
)

FOUND_PYTHON=""
for path in "${PYTHON_FRAMEWORK_PATHS[@]}"; do
    # ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰ã‚’å±•é–‹
    for expanded_path in $path; do
        if [ -d "$expanded_path" ]; then
            FOUND_PYTHON="$expanded_path"
            echo "âœ… Found Python.framework at: $FOUND_PYTHON"
            break 2
        fi
    done
done

if [ -z "$FOUND_PYTHON" ]; then
    echo "âŒ Python.framework not found!"
    echo "Searching in these locations:"
    for path in "${PYTHON_FRAMEWORK_PATHS[@]}"; do
        echo "  - $path"
    done
    echo ""
    echo "Please install Python $PYTHON_VERSION using one of the following methods:"
    echo ""
    echo "1. Official Python installer:"
    echo "   Download from https://www.python.org/downloads/"
    echo ""
    echo "2. Homebrew:"
    echo "   brew install python@$PYTHON_VERSION"
    echo ""
    echo "3. pyenv:"
    echo "   pyenv install $PYTHON_VERSION.7"
    echo ""
    exit 1
fi

echo "ğŸ“¦ Copying Python.framework..."
echo "From: $FOUND_PYTHON"
echo "To: $PYTHON_RUNTIME_DIR/$PYTHON_VERSION"

# Python.frameworkã®å†…å®¹ã‚’æ­£ã—ã„å ´æ‰€ã«ã‚³ãƒ”ãƒ¼
# ã‚³ãƒ”ãƒ¼å…ˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’æ˜ç¤ºçš„ã«ä½œæˆã—ã¦ã‹ã‚‰ã‚³ãƒ”ãƒ¼
TARGET_DIR="$PYTHON_RUNTIME_DIR/$PYTHON_VERSION"
mkdir -p "$TARGET_DIR"

# è©³ç´°ãªã‚³ãƒ”ãƒ¼å‡¦ç†ï¼ˆæ¨©é™ã‚¨ãƒ©ãƒ¼ã‚’å›é¿ï¼‰
echo "ğŸ”„ Copying directory contents..."
if ! cp -R "$FOUND_PYTHON/"* "$TARGET_DIR/" 2>/dev/null; then
    echo "âš ï¸ Standard copy failed, trying with sudo..."
    # sudoã‚’ä½¿ã£ã¦ã‚³ãƒ”ãƒ¼ã‚’è©¦è¡Œ
    if ! sudo cp -R "$FOUND_PYTHON/"* "$TARGET_DIR/" 2>/dev/null; then
        echo "âŒ Copy failed even with sudo. Trying alternative method..."
        
        # åˆ¥ã®æ–¹æ³•ï¼štar ã‚’ä½¿ç”¨
        echo "ğŸ”„ Using tar for copying..."
        (cd "$FOUND_PYTHON" && tar cf - .) | (cd "$TARGET_DIR" && tar xf -)
        
        if [ $? -ne 0 ]; then
            echo "âŒ All copy methods failed"
            exit 1
        fi
    fi
    
    # ã‚³ãƒ”ãƒ¼ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã®æ‰€æœ‰è€…ã‚’ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å¤‰æ›´
    echo "ğŸ”§ Changing ownership..."
    sudo chown -R $(whoami):$(id -gn) "$TARGET_DIR" 2>/dev/null || true
fi

# ã‚³ãƒ”ãƒ¼ã•ã‚ŒãŸãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ç¢ºèª
if [ ! -d "$TARGET_DIR" ]; then
    echo "âŒ Copy failed - target directory not found: $TARGET_DIR"
    exit 1
fi

# åŸºæœ¬ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
BASIC_FILES=(
    "$TARGET_DIR/bin"
    "$TARGET_DIR/lib"
    "$TARGET_DIR/include"
)

echo "ğŸ” Verifying copied structure..."
for dir in "${BASIC_FILES[@]}"; do
    if [ -d "$dir" ]; then
        echo "âœ… Found directory: $(basename "$dir")"
    else
        echo "âš ï¸ Missing directory: $(basename "$dir")"
    fi
done

# è©³ç´°ãªæ§‹é€ ç¢ºèª
echo "ğŸ“ Python runtime structure:"
ls -la "$TARGET_DIR/" | head -10

echo "ğŸ—‘ï¸ Cleaning up unnecessary files to reduce size..."

# __pycache__ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å‰Šé™¤
find "$TARGET_DIR" -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true

# .pycãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
find "$TARGET_DIR" -name "*.pyc" -delete 2>/dev/null || true

# ãƒ†ã‚¹ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å‰Šé™¤
find "$TARGET_DIR" -name "test" -type d -exec rm -rf {} + 2>/dev/null || true
find "$TARGET_DIR" -name "tests" -type d -exec rm -rf {} + 2>/dev/null || true

# ä¸è¦ãªãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å‰Šé™¤ï¼ˆã‚µã‚¤ã‚ºå‰Šæ¸›ï¼‰
MODULES_TO_REMOVE=(
    "tkinter"
    "turtle" 
    "idlelib"
    "lib2to3"
    "ensurepip"
)

PYTHON_LIB_DIR="$TARGET_DIR/lib/python$PYTHON_VERSION"
if [ -d "$PYTHON_LIB_DIR" ]; then
    for module in "${MODULES_TO_REMOVE[@]}"; do
        MODULE_PATH="$PYTHON_LIB_DIR/$module"
        if [ -d "$MODULE_PATH" ]; then
            echo "ğŸ—‘ï¸ Removing unnecessary module: $module"
            rm -rf "$MODULE_PATH"
        fi
    done
fi

# ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
find "$TARGET_DIR" -name "*.md" -delete 2>/dev/null || true
find "$TARGET_DIR" -name "*.rst" -delete 2>/dev/null || true
find "$TARGET_DIR" -name "*.txt" -delete 2>/dev/null || true

# å®Ÿè¡Œæ¨©é™ã‚’ç¢ºèªãƒ»è¨­å®š
PYTHON_EXECUTABLES=(
    "$TARGET_DIR/bin/python$PYTHON_VERSION"
    "$TARGET_DIR/bin/python3"
    "$TARGET_DIR/bin/python"
)

for exe in "${PYTHON_EXECUTABLES[@]}"; do
    if [ -f "$exe" ]; then
        chmod +x "$exe" 2>/dev/null || true
        echo "âœ… Made executable: $(basename "$exe")"
    fi
done

# ã‚µã‚¤ã‚ºã‚’ç¢ºèª
TOTAL_SIZE=$(du -sh "$PYTHON_RUNTIME_DIR" | cut -f1)
echo "ğŸ“Š Python runtime size: $TOTAL_SIZE"

# é‡è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
echo "ğŸ” Checking for required files..."

# Pythonå®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¢ã™
PYTHON_EXE=""
for exe in "${PYTHON_EXECUTABLES[@]}"; do
    if [ -f "$exe" ]; then
        PYTHON_EXE="$exe"
        echo "âœ… Found Python executable: $PYTHON_EXE"
        break
    fi
done

if [ -z "$PYTHON_EXE" ]; then
    echo "âŒ No Python executable found"
    echo "ğŸ“ Contents of bin directory:"
    ls -la "$TARGET_DIR/bin/" 2>/dev/null || echo "No bin directory found"
    exit 1
fi

# Pythonå…±æœ‰ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’æ¢ã™
DYLIB_PATTERNS=(
    "$TARGET_DIR/lib/libpython$PYTHON_VERSION.dylib"
    "$TARGET_DIR/lib/libpython$PYTHON_VERSION*.dylib"
    "$TARGET_DIR/lib/python$PYTHON_VERSION/config-*/libpython*.dylib"
    "$TARGET_DIR/Python"
)

FOUND_DYLIB=""
for pattern in "${DYLIB_PATTERNS[@]}"; do
    for file in $pattern; do
        if [ -f "$file" ]; then
            FOUND_DYLIB="$file"
            echo "âœ… Found Python library: $FOUND_DYLIB"
            break 2
        fi
    done
done

if [ -z "$FOUND_DYLIB" ]; then
    echo "âš ï¸ Python dynamic library not found, but continuing..."
    echo "ğŸ“ Contents of lib directory:"
    ls -la "$TARGET_DIR/lib/" 2>/dev/null | head -5
fi

# Pythonæ¨™æº–ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ç¢ºèª
if [ -d "$TARGET_DIR/lib/python$PYTHON_VERSION" ]; then
    echo "âœ… Found Python standard library: python$PYTHON_VERSION"
else
    echo "âŒ Python standard library not found"
    exit 1
fi

# Pythonå®Ÿè¡Œãƒ†ã‚¹ãƒˆ
echo "ï¿½ï¿½ Testing Python runtime..."
if "$PYTHON_EXE" -c "import sys; print(f'Python {sys.version} is working!')" 2>/dev/null; then
    echo "âœ… Python runtime test passed"
else
    echo "âš ï¸ Python runtime test failed, but continuing..."
    echo "ğŸ“‹ Python executable info:"
    file "$PYTHON_EXE" 2>/dev/null || echo "Cannot determine file type"
fi

echo ""
echo "âœ… Python runtime preparation completed!"
echo "ğŸ“ Runtime location: $PYTHON_RUNTIME_DIR"
echo "ğŸ Python version: $PYTHON_VERSION"
echo "ğŸ“Š Total size: $TOTAL_SIZE"
echo "ğŸ”§ Python executable: $PYTHON_EXE"
echo ""
echo "Next steps:"
echo "1. Run: npm run tauri:build-with-python"
echo "2. Or run: ./scripts/build-with-python.sh"
